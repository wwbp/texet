# Working Log

## 2026-01-07
- Project initialized with baseline docs.
- Added FastAPI scaffold with Dockerfile and Docker Compose.
- Collected official uv documentation references for installation and project workflow.
- Migrated dependencies to `pyproject.toml` and updated Docker build to use uv.
- Pinned Python 3.12 for uv and project metadata.
- Built and started the API with Docker Compose; health check returned OK.
- Added `.gitignore` to avoid committing local artifacts.
- Added Postgres service to Docker Compose with env templates.
- Verified Postgres is accepting connections via `pg_isready`.
- Wired the API to Postgres via async SQLAlchemy + asyncpg and added a DB connection test.
- Standardized DB URLs to use the Compose service host for both main and test databases.
- Fixed the DB test to keep passwords intact and verified it passes in Compose.
- Added chat endpoint with bearer-token auth, validation, and unit tests.
- Ran chat endpoint tests in Docker; all passed.
- Added coverage configuration and documented how to run full test suite with coverage.
- Ran full test suite with coverage in Docker; all tests passed.
- Simplified chat endpoint tests to the minimal critical cases.
- Re-ran full test suite with coverage after test simplification; all passed.
- Ran ruff (lint/format), mypy, and pip-audit; all clean.
- Added Makefile targets for start/stop/test/clean.
- Updated Makefile to require running services before test/clean.
- Adjusted Makefile to rebuild the api image for test/clean while requiring running services.
- Verified `make test` runs successfully with coverage in Docker.
- Ran `make stop`, `make start`, `make clean`, and `make test` end-to-end; all passed.
- Added Speaker model and DB ops helpers for speaker creation.
- Added Alembic setup and initial migration for speakers.
- Added Make targets and README docs for migrations.
- Updated uv.lock and ran ruff/mypy after adding Alembic files.
- Added async DB ops tests for speaker and bot creation using the test database.
- Ran full test suite after adding speaker tests; all passed.
- Updated tests to apply Alembic migrations for the test database and validate schema alignment.
- Reset test database before running migrations to avoid stale schema.
- Added linting, type checking, and vulnerability audit tooling.
- Ran `make test` in Docker; all 6 tests passed with 85% coverage.
- Ran `make clean`; ruff check/format, mypy, and pip-audit all passed.
- Verified main Postgres schema via `psql`; no tables present (migrations not yet applied to the primary DB).
- Applied migrations to the primary DB; `speakers` and `alembic_version` tables now present.
- Updated README overview to reflect Postgres + migrations scope.
- Moved `created_at` to the SQLAlchemy base model for shared timestamps.
- Added `Conversation` and `Utterance` models plus db ops for creating conversations and utterances.
- Added an Alembic migration to create conversations/utterances and add `created_at` to speakers.
- Adjusted Makefile migration targets to bind-mount the repo so new revisions persist on disk.
- Added db ops tests for conversations/utterances and ran the full test suite (all passing).
- Wired chat handler to persist conversations and utterances with a stubbed reply.
- Updated chat response schema and endpoint to use async DB session dependency.
- Reworked chat endpoint tests to use AsyncClient, test persistence, and validate response shape.
- Ran `make test`; all 8 tests passed.
- Added a partial unique index to enforce one open conversation per user.
- Implemented get-or-create conversation logic with savepoints for concurrency safety.
- Updated chat flow/tests to reuse the open conversation and validate utterance counts.
- Applied migrations before generating the new index migration.
- Ran `make test`; all 9 tests passed.
- Added an interleaved multi-user chat test to validate conversation reuse and persistence.
- Ran `make test`; all 10 tests passed.
- Applied latest migrations (`make migrate`).
- Ran `make clean` and `make test`; all checks/tests passed.
- Stopped the Docker stack (`make stop`).
